# Cloud Build Trigger Configuration
# This file can be used to create a trigger manually if needed

triggerTemplate:
  projectId: $PROJECT_ID
  branchName: main
  repoName: fazendapro

build:
  steps:
    - name: 'gcr.io/cloud-builders/docker'
      args: 
        - 'build'
        - '-t'
        - 'gcr.io/$PROJECT_ID/fazendapro-api:$COMMIT_SHA'
        - '-t'
        - 'gcr.io/$PROJECT_ID/fazendapro-api:latest'
        - '.'
      dir: '.'

    - name: 'gcr.io/cloud-builders/docker'
      args: ['push', 'gcr.io/$PROJECT_ID/fazendapro-api:$COMMIT_SHA']

    - name: 'gcr.io/cloud-builders/docker'
      args: ['push', 'gcr.io/$PROJECT_ID/fazendapro-api:latest']

    - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
      entrypoint: gcloud
      args:
        - 'run'
        - 'deploy'
        - 'fazendapro-api'
        - '--image'
        - 'gcr.io/$PROJECT_ID/fazendapro-api:$COMMIT_SHA'
        - '--region'
        - 'us-central1'
        - '--platform'
        - 'managed'
        - '--allow-unauthenticated'
        - '--port'
        - '8080'
        - '--memory'
        - '512Mi'
        - '--cpu'
        - '1'
        - '--max-instances'
        - '10'

  images:
    - 'gcr.io/$PROJECT_ID/fazendapro-api:$COMMIT_SHA'
    - 'gcr.io/$PROJECT_ID/fazendapro-api:latest' 